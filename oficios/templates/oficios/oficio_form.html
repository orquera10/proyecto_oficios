{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card oficio-form-card">
                <div class="card-header">
                    <h4>{{ titulo }}</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="oficio-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Mensajes de error generales del formulario -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Datos principales del oficio -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Datos del Oficio</h5>
                            </div>
                            <div class="card-body">
                                {{ form.caso }}
                                <div class="row g-3">
                                    <div class="col-12 col-md-4">
                                        {{ form.nro_oficio|as_crispy_field }}
                                    </div>
                                    <div class="col-12 col-md-4">
                                        {{ form.denuncia|as_crispy_field }}
                                    </div>
                                    <div class="col-12 col-md-4">
                                        {{ form.legajo|as_crispy_field }}
                                    </div>
                                    <div class="col-12 col-md-4">
                                        {{ form.fecha_emision|as_crispy_field }}
                                    </div>
                                    <div class="col-12 col-md-2">
                                        {{ form.plazo_horas|as_crispy_field }}
                                    </div>
                                    <div class="col-12 col-md-2 pe-md-2">
                                        <label class="form-label d-block">Unidad de plazo</label>
                                        <div class="btn-group w-100" role="group" aria-label="Unidad de plazo">
                                            <input type="radio" class="btn-check" name="plazo_unidad" id="plazo-unidad-horas" value="horas" {% if form.plazo_unidad.value == 'horas' or not form.plazo_unidad.value %}checked{% endif %}>
                                            <label class="btn btn-outline-primary flex-fill" for="plazo-unidad-horas">Horas</label>
                                            <input type="radio" class="btn-check" name="plazo_unidad" id="plazo-unidad-dias" value="dias" {% if form.plazo_unidad.value == 'dias' %}checked{% endif %}>
                                            <label class="btn btn-outline-primary flex-fill" for="plazo-unidad-dias">Días</label>
                                        </div>
                                        {% if form.plazo_unidad.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.plazo_unidad.errors|join:", " }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12 col-md-4 ps-md-1">
                                        <label class="form-label">Fecha de vencimiento (estimada)</label>
                                        <input type="datetime-local" class="form-control" id="fecha_vencimiento_preview" readonly>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        {{ form.juzgado|as_crispy_field }}
                                    </div>
                                    <div class="col-12 col-md-6">
                                        {{ form.caratula|as_crispy_field }}
                                    </div>
                                    <div class="col-12 col-md-12">
                                        {{ form.caratula_oficio|as_crispy_field }}
                                    </div>
                                    <div class="col-12">
                                        {{ form.archivo_pdf|as_crispy_field }}
                                    </div>
                                    <div class="col-12">
                                        {{ form.instituciones|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección de Datos del Oficio -->

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <a href="{% url 'oficios:list' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<script>
$(document).ready(function() {
    // Inicializar select2 para los selects existentes
    $('select').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Seleccione una opcion',
        allowClear: true,
        dropdownParent: $('#oficio-form'),
        dropdownAutoWidth: true
    });
    
    // Configurar select2 para los nuevos selects que se agreguen dinámicamente
    $(document).on('select2:open', function() {
        const el = document.querySelector('.select2-container--open .select2-search__field');
        if (el) {
            try { el.focus({ preventScroll: true }); } catch (e) { el.focus(); }
        }
    });

    function pad2(value) {
        return String(value).padStart(2, '0');
    }

    function formatLocalDateTime(date) {
        if (!date || isNaN(date.getTime())) return '';
        const yyyy = date.getFullYear();
        const mm = pad2(date.getMonth() + 1);
        const dd = pad2(date.getDate());
        const hh = pad2(date.getHours());
        const mi = pad2(date.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function updateFechaVencimientoPreview() {
        const plazoInput = document.getElementById('id_plazo_horas');
        const fechaEmisionInput = document.getElementById('id_fecha_emision');
        const preview = document.getElementById('fecha_vencimiento_preview');
        if (!plazoInput || !fechaEmisionInput || !preview) return;

        const plazoValor = parseFloat(plazoInput.value);
        if (!plazoValor || plazoValor <= 0) {
            preview.value = '';
            return;
        }

        const fechaValor = fechaEmisionInput.value;
        if (!fechaValor) {
            preview.value = '';
            return;
        }

        const unidad = document.querySelector('input[name="plazo_unidad"]:checked')?.value || 'horas';
        const horas = unidad === 'dias' ? plazoValor * 24 : plazoValor;
        const base = new Date(fechaValor);
        if (isNaN(base.getTime())) {
            preview.value = '';
            return;
        }
        base.setHours(base.getHours() + horas);
        preview.value = formatLocalDateTime(base);
    }

    document.getElementById('id_plazo_horas')?.addEventListener('input', updateFechaVencimientoPreview);
    document.getElementById('id_fecha_emision')?.addEventListener('input', updateFechaVencimientoPreview);
    document.querySelectorAll('input[name="plazo_unidad"]').forEach((el) => {
        el.addEventListener('change', updateFechaVencimientoPreview);
    });
    updateFechaVencimientoPreview();
});
</script>
{% endblock %}
