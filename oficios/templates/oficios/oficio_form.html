    {% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>{{ titulo }}</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="oficio-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Mensajes de error generales del formulario -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Datos principales del oficio -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Datos del Oficio</h5>
                            </div>
                            <div class="card-body">
                                {{ form|crispy }}
                            </div>
                        </div>

                        <!-- Sección de Datos del Oficio -->

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <a href="{% url 'oficios:list' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<script>
$(document).ready(function() {
    // Inicializar select2 para los selects existentes
    $('select').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Seleccione una opción',
        allowClear: true
    });
    
    // Configurar select2 para los nuevos selects que se agreguen dinámicamente
    $(document).on('select2:open', () => {
        document.querySelector('.select2-search__field').focus();
    });
});
</script>
        }

        // Validar que cada parte seleccionada tenga vínculo
        let faltanVinculos = false;
        $('#tablaPartes tbody tr').each(function() {
            const $tr = $(this);
            const chk = $tr.find('.parte-checkbox');
            if (chk.is(':checked')) {
                const vincInp = $tr.find('.input-vinculo');
                const val = (vincInp.val() || '').trim();
                if (!val) {
                    faltanVinculos = true;
                    vincInp.addClass('is-invalid');
                    if ($tr.find('.invalid-feedback').length === 0) {
                        $('<div class="invalid-feedback">Ingrese el vínculo</div>').insertAfter(vincInp);
                    }
                }
            }
        });
        if (faltanVinculos) {
            // Mensaje simple; se resalta cada fila con error
            return;
        }

        const totalForms = $('#id_partes-TOTAL_FORMS');
        let formIdx = parseInt(totalForms.val());

        // Obtener IDs de partes ya en el formset (solo las NO marcadas para eliminar) para evitar duplicados
        const existentes = new Set();
        $('#parte-formset .parte-form').each(function() {
            const delHidden = $(this).find('input[type="hidden"][name$="-DELETE"]').val() === 'on';
            const delChk = $(this).find('input[type="checkbox"][id$="-DELETE"]').is(':checked');
            const del = delHidden || delChk;
            if (del) return; // ignorar eliminadas
            const sel = $(this).find('select[name$="-parte"]');
            const val = sel.val();
            if (val) existentes.add(parseInt(val));
        });

        // Plantilla: usar primera fila como base
        let baseForm = $('.parte-form:first');
        if (baseForm.length === 0) {
            // Si por alguna razón no hay fila base (no debería suceder), crear una estructura mínima
            baseForm = $('<div class="parte-form row mb-3 border-bottom pb-3">');
            baseForm.append('<div class="col-md-4"><select name="partes-0-parte" class="form-select select2"></select></div>');
            baseForm.append('<div class="col-md-4"><input type="text" name="partes-0-tipo_relacion" class="form-control" /></div>');
            baseForm.append('<div class="col-md-4"><div class="form-check form-switch"><input type="checkbox" name="partes-0-DELETE" id="id_partes-0-DELETE" class="form-check-input" /><label class="form-check-label ms-2" for="id_partes-0-DELETE">Eliminar</label></div></div>');
            $('#parte-formset').append(baseForm);
            if (isNaN(formIdx)) formIdx = 1; else formIdx = Math.max(formIdx, 1);
        }

        partesSeleccionadas.forEach((vinculo, parteId) => {
            if (existentes.has(parseInt(parteId))) {
                return; // evitar duplicados
            }
            const newForm = baseForm.clone(true);

            // Reset valores
            newForm.find(':input').each(function() {
                const oldName = $(this).attr('name');
                if (!oldName) return;
                const name = oldName.replace(/partes-\d+-/g, 'partes-' + formIdx + '-');
                const id = 'id_' + name.replace(/-/g, '_');
                $(this).attr({ 'name': name, 'id': id });

                if ($(this).is('select')) {
                    $(this).val('');
                } else if ($(this).is(':checkbox')) {
                    $(this).prop('checked', false);
                } else {
                    $(this).val('');
                }
            });

            // Asignar parte y vínculo
            const selectParte = newForm.find('select[name$="-parte"]');
            // Asegurar que exista la opción en el select
            if (selectParte.find('option[value="' + String(parteId) + '"]').length === 0) {
                const info = partesInfo.get(parseInt(parteId));
                const label = info ? `${info.apellido}, ${info.nombre}${info.dni ? ' (DNI: ' + info.dni + ')' : ''}` : ('Parte #' + String(parteId));
                const opt = $('<option>').attr('value', String(parteId)).text(label);
                selectParte.append(opt);
            }
            selectParte.val(String(parteId));
            // Reinit select2
            selectParte.removeClass('select2-hidden-accessible');
            selectParte.next('.select2-container').remove();
            selectParte.select2({ theme:'bootstrap-5', width:'100%', allowClear:true, placeholder:'Seleccione una parte' });
            selectParte.trigger('change.select2');

            const inputVinculo = newForm.find('input[name$="-tipo_relacion"]');
            inputVinculo.val(vinculo || '');

            // Asegurar DELETE desmarcado y visible
            const deleteCheckbox = newForm.find('input[type="checkbox"][id$="-DELETE"]');
            deleteCheckbox.prop('checked', false);
            deleteCheckbox.closest('.form-check').show();

            // Añadir al contenedor
            $('#parte-formset').append(newForm);

            formIdx += 1;
        });

        totalForms.val(formIdx);
        updatePartesFormsetCount();
        setupDeleteHandlers();
        actualizarPartesResumen();

        const modal = bootstrap.Modal.getInstance(document.getElementById('partesModal'));
        modal.hide();
        // Limpiar selección del modal para próxima vez
        partesSeleccionadas.clear();
        $('#tablaPartes tbody').empty();
    });

    // Antes de enviar el formulario, asegurar management_form y TOTAL_FORMS correcto
    $('#oficio-form').on('submit', function() {
        updatePartesFormsetCount();
        ensurePartesManagementForm();
    });

    // Render de resumen de Partes seleccionadas (similar a Niños)
    function actualizarPartesResumen() {
        const container = $('#partes-seleccionadas');
        container.empty();

        // Filtrar formularios no eliminados y con parte seleccionada (evitar la fila extra vacía)
        const forms = $('#parte-formset .parte-form').filter(function() {
            const delHidden = $(this).find('input[type="hidden"][name$="-DELETE"]').val() === 'on';
            const delChk = $(this).find('input[type="checkbox"][id$="-DELETE"]').is(':checked');
            const del = delHidden || delChk;
            const selectParte = $(this).find('select[name$="-parte"]');
            const tieneParte = (selectParte.val() || '').toString().length > 0;
            return !del && tieneParte;
        });

        if (forms.length === 0) {
            container.append('<div class="alert alert-info mb-0">No hay partes seleccionadas</div>');
            return;
        }

        const lista = $('<div class="list-group">');
        forms.each(function(idx) {
            const row = $(this);
            const selectParte = row.find('select[name$="-parte"]');
            const parteTxt = selectParte.find('option:selected').text() || 'Parte sin nombre';
            const vinculo = row.find('input[name$="-tipo_relacion"]').val() || '';
            const parteId = (selectParte.val() || '').toString();

            const item = $(`
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        ${parteTxt}
                        ${vinculo ? '<span class="text-muted">— Vínculo: ' + $('<div>').text(vinculo).html() + '</span>' : ''}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-quitar-parte" data-index="${idx}" data-parte-id="${parteId}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            lista.append(item);
        });
        container.append(lista);

        // Quitar parte desde el resumen
        $('.btn-quitar-parte').on('click', function() {
            const parteId = ($(this).data('parte-id') || '').toString();
            let targetRow = null;
            // Buscar por parteId explícito
            $('#parte-formset .parte-form').each(function() {
                const delHidden = $(this).find('input[type="hidden"][name$="-DELETE"]').val() === 'on';
                const delChk = $(this).find('input[type="checkbox"][id$="-DELETE"]').is(':checked');
                const del = delHidden || delChk;
                const selectParte = $(this).find('select[name$="-parte"]');
                const val = (selectParte.val() || '').toString();
                if (!del && val === parteId) {
                    targetRow = $(this);
                    return false; // break
                }
            });
            // Si no se encontró por parteId (fallback al índice visible)
            if (!targetRow) {
                const idx = parseInt($(this).data('index'));
                targetRow = $('#parte-formset .parte-form').filter(function() {
                    const delHidden = $(this).find('input[type="hidden"][name$="-DELETE"]').val() === 'on';
                    const delChk = $(this).find('input[type="checkbox"][id$="-DELETE"]').is(':checked');
                    const del = delHidden || delChk;
                    const selectParte = $(this).find('select[name$="-parte"]');
                    const tieneParte = (selectParte.val() || '').toString().length > 0;
                    return !del && tieneParte;
                }).eq(idx);
            }
            // Marcar DELETE según el tipo de input presente (hidden o checkbox)
            if (targetRow && targetRow.length) {
                const delHidden = targetRow.find('input[type="hidden"][name$="-DELETE"]');
                if (delHidden.length) {
                    delHidden.val('on');
                } else {
                    targetRow.find('input[type="checkbox"][id$="-DELETE"]').prop('checked', true);
                }
                targetRow.slideUp(200, function(){ targetRow.hide(); });
            }
            updatePartesFormsetCount();
            actualizarPartesResumen();
        });
    }

    // Actualizar resumen cuando cambian selects o vínculos en el formset
    $(document).on('change', '#parte-formset select[name$="-parte"]', actualizarPartesResumen);
    $(document).on('input', '#parte-formset input[name$="-tipo_relacion"]', actualizarPartesResumen);

    // Render inicial
    actualizarPartesResumen();
});
</script>
{% endblock %}
