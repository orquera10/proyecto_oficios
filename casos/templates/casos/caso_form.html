{% extends 'casos/base_casos.html' %}

{% block page_title %}{% if object %}Editar{% else %}Nuevo{% endif %} Caso{% endblock %}

{% block casos_content %}
<div class="card">
    <div class="card-body">
        <form method="post" id="caso-form">
            {% csrf_token %}
            
            <!-- Campos ocultos para los formsets -->
            <div id="hidden-forms" style="display: none;">
                {{ nino_formset.management_form }}
                {{ parte_formset.management_form }}
                <div id="nino-forms"></div>
                <div id="parte-forms"></div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Datos del Caso</h5>
                        </div>
                        <div class="card-body">
                            {{ form.as_p }}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Niños Relacionados</h5>
                        </div>
                        <div class="card-body">
                            <button type="button" class="btn btn-outline-primary" id="add-nino-modal" data-bs-toggle="modal" data-bs-target="#ninosModal">
                                <i class="fas fa-plus"></i> Agregar Niño
                            </button>
                            <!-- Contenedor para los niños seleccionados -->
                            <div id="ninos-seleccionados-display" class="mt-3">
                                <!-- Aquí se agregarán los niños seleccionados -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Partes Relacionadas</h5>
                        </div>
                        <div class="card-body">
                            <button type="button" class="btn btn-outline-primary" id="add-parte-modal" data-bs-toggle="modal" data-bs-target="#partesModal">
                                <i class="fas fa-plus"></i> Agregar Parte
                            </button>
                            <div id="partes-seleccionadas-display" class="mt-3">
                                <!-- Aquí se agregarán las partes seleccionadas -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{% if object %}{% url 'casos:detail' object.pk %}{% else %}{% url 'casos:list' %}{% endif %}" 
                   class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para seleccionar niños -->
<div class="modal fade" id="ninosModal" tabindex="-1" aria-labelledby="ninosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ninosModalLabel">Seleccionar Niño</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="buscarNino" placeholder="Buscar por nombre o apellido...">
                        <button class="btn btn-outline-primary" type="button" id="btnBuscarNino">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaNinos">
                        <thead>
                            <tr>
                                <th>Seleccionar</th>
                                <th>Apellido</th>
                                <th>Nombre</th>
                                <th>DNI</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los niños se cargarán aquí mediante JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="confirmarNinos">Confirmar selección</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para seleccionar partes -->
<div class="modal fade" id="partesModal" tabindex="-1" aria-labelledby="partesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="partesModalLabel">Seleccionar Parte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="buscarParte" placeholder="Buscar por nombre, apellido o DNI...">
                        <button class="btn btn-outline-primary" type="button" id="btnBuscarParte">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaPartes">
                        <thead>
                            <tr>
                                <th>Sel</th>
                                <th>Apellido</th>
                                <th>Nombre</th>
                                <th>DNI</th>
                                <th>Vínculo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Partes por JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="confirmarPartes">Confirmar selección</button>
            </div>
        </div>
    </div>
</div>

<div id="nino-form-template" style="display: none;">
    {{ nino_formset.empty_form.as_p }}
</div>

<div id="parte-form-template" style="display: none;">
    {{ parte_formset.empty_form.as_p }}
</div>


{% block extra_js %}
<script>
$(document).ready(function() {
    // NIÑOS
    let ninosDisponibles = [];
    let ninosSeleccionados = [];
    let ninoFormIndex = 0;

    function cargarNinos(busqueda = '') {
        $.ajax({
            url: '{% url "personas:api_ninos" %}',
            method: 'GET',
            data: { 'search': busqueda },
            success: function(response) {
                ninosDisponibles = Array.isArray(response) ? response : [];
                actualizarTablaNinos();
            },
            error: function() {
                $('#tablaNinos tbody').html('<tr><td colspan="4" class="text-center text-danger">Error al cargar los niños.</td></tr>');
            }
        });
    }

    function actualizarTablaNinos() {
        const tbody = $('#tablaNinos tbody');
        tbody.empty();
        if (ninosDisponibles.length === 0) {
            tbody.html('<tr><td colspan="4" class="text-center">No se encontraron niños.</td></tr>');
            return;
        }
        ninosDisponibles.forEach(nino => {
            const isSelected = ninosSeleccionados.some(n => n.id === nino.id);
            const tr = $(`
                <tr>
                    <td>
                        <input type="checkbox" name="seleccionNino" value="${nino.id}" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${nino.apellido}</td>
                    <td>${nino.nombre}</td>
                    <td>${nino.dni}</td>
                </tr>
            `);
            tbody.append(tr);
        });
    }

    function initNinosModal() {
        cargarNinos();
        $('#buscarNino').trigger('focus');
    }
    
    function initPartesModal() {
        cargarPartes();
        $('#buscarParte').trigger('focus');
    }
    
    // Initialize modals
    const ninosModal = document.getElementById('ninosModal');
    if (ninosModal) {
        ninosModal.addEventListener('shown.bs.modal', initNinosModal);
    }
    
    const partesModal = document.getElementById('partesModal');
    if (partesModal) {
        partesModal.addEventListener('shown.bs.modal', initPartesModal);
    }
    
    // Search handlers
    $('#btnBuscarNino').on('click', () => cargarNinos($('#buscarNino').val()));
    $('#buscarNino').on('keypress', e => { if (e.which === 13) { e.preventDefault(); $('#btnBuscarNino').trigger('click'); } });

    $('#confirmarNinos').on('click', function() {
        $('input[name="seleccionNino"]:checked').each(function() {
            const ninoId = parseInt($(this).val());
            const nino = ninosDisponibles.find(n => n.id === ninoId);
            
            if (nino && !ninosSeleccionados.some(n => n.id === ninoId)) {
                ninosSeleccionados.push(nino);
            }
        });
        
        actualizarNinosDisplay();
        actualizarNinoFormset();
        $('#ninosModal').modal('hide');
        
        // Limpiar búsqueda y selección
        $('#buscarNino').val('');
        $('input[name="seleccionNino"]').prop('checked', false);
    });

    function actualizarNinosDisplay() {
        const container = $('#ninos-seleccionados-display');
        container.empty();
        
        if (ninosSeleccionados.length === 0) {
            container.html('<p class="text-muted">No hay niños seleccionados.</p>');
            return;
        }
        
        const ul = $('<ul class="list-group"></ul>');
        
        ninosSeleccionados.forEach(nino => {
            const li = $(`
                <li class="list-group-item d-flex justify-content-between align-items-center" data-nino-id="${nino.id}">
                    ${nino.nombre} ${nino.apellido} (DNI: ${nino.dni})
                    <button type="button" class="btn btn-sm btn-outline-danger btn-remove-nino">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `);
            ul.append(li);
        });
        
        container.html(ul);
    }

    function actualizarNinoFormset() {
        const container = $('#nino-forms');
        container.empty();
        
        ninosSeleccionados.forEach((nino, index) => {
            const formId = `nino-form-${index}`;
            const form = $(`
                <div id="${formId}" class="nino-form">
                    <input type="hidden" name="ninos-${index}-nino" value="${nino.id}">
                    <input type="hidden" name="ninos-${index}-id" value="">
                    <input type="hidden" name="ninos-${index}-caso" value="">
                    <input type="hidden" name="ninos-${index}-DELETE" id="id_ninos-${index}-DELETE">
                </div>
            `);
            container.append(form);
        });
        
        // Actualizar el formulario de gestión
        $('#id_ninos-TOTAL_FORMS').val(ninosSeleccionados.length);
    }

    // PARTES
    let partesDisponibles = [];
    let partesSeleccionadas = [];
    let parteFormIndex = 0;

    function cargarPartes(busqueda = '') {
        $.ajax({
            url: '{% url "personas:api_partes" %}',
            method: 'GET',
            data: { 'search': busqueda },
            success: function(response) {
                partesDisponibles = Array.isArray(response) ? response : [];
                actualizarTablaPartes();
            },
            error: function() {
                $('#tablaPartes tbody').html('<tr><td colspan="5" class="text-center text-danger">Error al cargar las partes.</td></tr>');
            }
        });
    }

    function actualizarTablaPartes() {
        const tbody = $('#tablaPartes tbody');
        tbody.empty();
        
        if (partesDisponibles.length === 0) {
            tbody.html('<tr><td colspan="5" class="text-center">No se encontraron partes.</td></tr>');
            return;
        }
        
        partesDisponibles.forEach(parte => {
            const isSelected = partesSeleccionadas.some(p => p.id === parte.id);
            const selectedParte = isSelected ? partesSeleccionadas.find(p => p.id === parte.id) : null;
            
            const tr = $(`
                <tr>
                    <td>
                        <input type="checkbox" name="seleccionParte" value="${parte.id}" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${parte.apellido}</td>
                    <td>${parte.nombre}</td>
                    <td>${parte.dni}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm" id="vinculo-${parte.id}" 
                               placeholder="Vínculo" value="${selectedParte ? selectedParte.vinculo : ''}">
                    </td>
                </tr>
            `);
            tbody.append(tr);
        });
    }

    // Search handlers for partes
    $('#btnBuscarParte').on('click', () => cargarPartes($('#buscarParte').val()));
    $('#buscarParte').on('keypress', e => { if (e.which === 13) { e.preventDefault(); $('#btnBuscarParte').trigger('click'); } });

    $('#confirmarPartes').on('click', function() {
        $('input[name="seleccionParte"]:checked').each(function() {
            const parteId = parseInt($(this).val());
            const vinculo = $(`#vinculo-${parteId}`).val() || 'No especificado';
            const parte = partesDisponibles.find(p => p.id === parteId);
            
            if (parte && !partesSeleccionadas.some(p => p.id === parteId)) {
                partesSeleccionadas.push({
                    id: parte.id,
                    nombre: parte.nombre,
                    apellido: parte.apellido,
                    dni: parte.dni,
                    vinculo: vinculo
                });
            }
        });
        
        actualizarPartesDisplay();
        actualizarParteFormset();
        $('#partesModal').modal('hide');
        
        // Limpiar búsqueda y selección
        $('#buscarParte').val('');
        $('input[name="seleccionParte"]').prop('checked', false);
    });

    function actualizarPartesDisplay() {
        const container = $('#partes-seleccionadas-display');
        container.empty();
        
        if (partesSeleccionadas.length === 0) {
            container.html('<p class="text-muted">No hay partes seleccionadas.</p>');
            return;
        }
        
        const ul = $('<ul class="list-group"></ul>');
        
        partesSeleccionadas.forEach(parte => {
            const li = $(`
                <li class="list-group-item" data-parte-id="${parte.id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${parte.nombre} ${parte.apellido} (DNI: ${parte.dni})</strong><br>
                            <small class="text-muted">Vínculo: ${parte.vinculo || 'No especificado'}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-parte">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </li>
            `);
            ul.append(li);
        });
        
        container.html(ul);
    }

    function actualizarParteFormset() {
        const container = $('#parte-forms');
        container.empty();
        
        partesSeleccionadas.forEach((parte, index) => {
            const formId = `parte-form-${index}`;
            const form = $(`
                <div id="${formId}" class="parte-form">
                    <input type="hidden" name="partes-${index}-parte" value="${parte.id}">
                    <input type="hidden" name="partes-${index}-tipo_relacion" value="${parte.vinculo || ''}">
                    <input type="hidden" name="partes-${index}-id" value="">
                    <input type="hidden" name="partes-${index}-caso" value="">
                    <input type="hidden" name="partes-${index}-DELETE" id="id_partes-${index}-DELETE">
                </div>
            `);
            container.append(form);
        });
        
        // Actualizar el formulario de gestión
        $('#id_partes-TOTAL_FORMS').val(partesSeleccionadas.length);
    }

    // Cargar datos iniciales si estamos en edición
    {% if object %}
    $(document).ready(function() {
        // Limpiar arrays para evitar duplicados
        ninosSeleccionados = [];
        partesSeleccionadas = [];

        // Cargar niños existentes
        {% for form in nino_formset %}
            {% if form.instance.pk and form.instance.nino %}
                ninosSeleccionados.push({
                    id: {{ form.instance.nino.id_ninos }},
                    nombre: '{{ form.instance.nino.nombre|escapejs }}',
                    apellido: '{{ form.instance.nino.apellido|escapejs }}',
                    dni: '{{ form.instance.nino.dni|default:""|escapejs }}',
                    observaciones: '{{ form.instance.observaciones|default:""|escapejs }}'
                });
            {% endif %}
        {% endfor %}

        // Cargar partes existentes
        {% for form in parte_formset %}
            {% if form.instance.pk and form.instance.parte %}
                partesSeleccionadas.push({
                    id: {{ form.instance.parte.id_partes }},
                    nombre: '{{ form.instance.parte.nombre|escapejs }}',
                    apellido: '{{ form.instance.parte.apellido|escapejs }}',
                    dni: '{{ form.instance.parte.dni|default:""|escapejs }}',
                    vinculo: '{{ form.instance.tipo_relacion|default:""|escapejs }}'
                });
            {% endif %}
        {% endfor %}

        // Actualizar la interfaz
        actualizarNinosDisplay();
        actualizarNinoFormset();
        actualizarPartesDisplay();
        actualizarParteFormset();
    });
    {% endif %}

});
</script>
{% endblock %}
{% endblock %}
